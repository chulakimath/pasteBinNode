<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= data?.name %></title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f8fafc;
    }

    .container {
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .ws-status {
      font-size: 12px;
      margin-bottom: 8px;
      color: gray;
    }

    .link-box {
      font-size: 13px;
      background: #fff;
      border: 1px solid #e2e8f0;
      padding: 6px;
      border-radius: 4px;
      margin-bottom: 10px;
      word-break: break-all;
    }

    textarea {
      width: 100%;
      height: calc(100vh - 220px);
      min-height: 300px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }

    .char-count {
      font-size: 12px;
      color: #64748b;
      text-align: right;
      margin-top: 4px;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    button {
      background: #6366f1;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.9;
    }

    .status {
      font-size: 12px;
      color: green;
      margin-top: 6px;
      display: none;
    }

    .locked {
      border: 2px solid red !important;
      background: #fff5f5;
    }

    .save-status {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      display: inline-block;
      background: #dcfce7;
      color: #166534;
    }

    .unsaved {
      background: #fef3c7;
      color: #92400e;
    }

    .saved {
      background: #dcfce7;
      color: #166534;
    }
  </style>
</head>

<body>

  <div class="container">

    <div class="title"><%= data?.name %></div>
    <div id="wsStatus" class="ws-status">Connecting...</div>
    <div id="editStatus" class="ws-status"></div>
    <div id="saveStatus" class="ws-status"></div>

    <div id="copyStatus" class="status">Saved</div>


    <div id="pasteLink" class="link-box">
      <%= data?.post_key %>
    </div>

    <textarea id="body" maxlength="10000"><%= data?.body %></textarea>
    <div id="charCount" class="char-count">0 / 10000</div>

    <div class="actions">
      <button onclick="savePaste()">Save</button>
      <button onclick="copyBody()">Copy</button>
      <button onclick="copyLink()">Copy Link</button>
      <button onclick="location.href='/raw/<%= data?.post_key %>'">Raw</button>
    </div>


  </div>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();
    const pasteKey = "<%= data?.post_key %>";

    const textarea = document.getElementById("body");
    const charCount = document.getElementById("charCount");
    const wsStatus = document.getElementById("wsStatus");
    const editStatus = document.getElementById("editStatus");
    const saveStatus = document.getElementById("saveStatus");

    function setUnsaved() {
      saveStatus.innerText = "Unsaved changes…";
      saveStatus.classList.remove("saved");
      saveStatus.classList.add("unsaved");
    }

    function setSaved() {
      saveStatus.innerText = "Synced ✓";
      saveStatus.classList.remove("unsaved");
      saveStatus.classList.add("saved");
    }
    let timer = null;
    let typingTimer = null;
    let isLockedByMe = false;
    let autosaveTimer = null;
    const LOCK_TIMEOUT = 10000; // 10 seconds
    const AUTOSAVE_DELAY = 5000; //


    textarea.addEventListener("input", () => {

      setUnsaved(); // <-- important line

      if (!isLockedByMe) {
        socket.emit("lockPaste", {
          pasteKey
        });
        isLockedByMe = true;
      }

      clearTimeout(typingTimer);
      clearTimeout(autosaveTimer);

      autosaveTimer = setTimeout(() => {
        socket.emit("updatePaste", {
          pasteKey,
          body: textarea.value
        });

        setSaved(); // <-- mark saved after autosave
      }, AUTOSAVE_DELAY);

      typingTimer = setTimeout(() => {
        socket.emit("unlockPaste", {
          pasteKey
        });
        isLockedByMe = false;
      }, LOCK_TIMEOUT);
    });




    textarea.addEventListener("blur", () => {
      clearTimeout(typingTimer);
      clearTimeout(autosaveTimer);

      if (isLockedByMe) {
        socket.emit("unlockPaste", {
          pasteKey
        });
        isLockedByMe = false;
      }
    });



    function showStatus(msg) {
      const status = document.getElementById("copyStatus");
      clearTimeout(timer);
      status.innerText = msg;
      status.style.display = "block";
      timer = setTimeout(() => status.style.display = "none", 2000);
    }

    // Character counter
    function updateCount() {
      charCount.innerText = `${textarea.value.length} / 10000`;
    }
    textarea.addEventListener("input", updateCount);
    updateCount();

    // Socket connection
    socket.on("connect", () => {
      wsStatus.innerText = "Live ✓";
      wsStatus.style.color = "green";
      socket.emit("joinPaste", {
        pasteKey
      });
    });

    socket.on("disconnect", () => {
      wsStatus.innerText = "Disconnected";
      wsStatus.style.color = "red";
    });

    socket.on("pasteUpdated", (data) => {
      textarea.value = data.body;
      updateCount();
   
      textarea.readOnly = false;
      textarea.classList.remove("locked");
      editStatus.innerText = "";
      setSaved();
      showStatus("Updated from another viewer");
    });


    textarea.addEventListener("focus", () => {
      socket.emit("lockPaste", {
        pasteKey
      });
    });

    textarea.addEventListener("blur", () => {
      socket.emit("unlockPaste", {
        pasteKey
      });
    });
    socket.on("lock", (data) => {

      if (data.lock && !isLockedByMe) {
        textarea.readOnly = true;
        textarea.classList.add("locked");
        editStatus.innerText = "Someone is editing…";
        editStatus.style.color = "red";
      }

      if (!data.lock) {
        textarea.readOnly = false;
        textarea.classList.remove("locked");
        editStatus.innerText = "";
      }

    });


    function savePaste() {
      socket.emit("lockPaste", {
        pasteKey
      });
      socket.emit("updatePaste", {
        pasteKey,
        body: textarea.value
      });
      showStatus("Saved ✓");
      setSaved();
    }

    function copyBody() {
      navigator.clipboard.writeText(textarea.value)
        .then(() => showStatus("Copied ✓"));
    }

    function copyLink() {
      navigator.clipboard.writeText(location.href)
        .then(() => showStatus("Link copied ✓"));
    }
  </script>

</body>

</html>